#!/usr/bin/env python3
import boto3
import logging
import argh
import cli_aws
import shell
from util.retry import retry

def main(*selectors, yes=False):
    assert selectors, 'you cannot stop all things, specify some selectors'
    assert selectors != ('*',), 'you cannot stop all things, specify some selectors'
    pendings = cli_aws.ls(selectors, 'pending')
    if pendings:
        logging.info('wait for pending instances before stop:')
        for pending in pendings:
            logging.info(' %s', cli_aws.format(pending))
        shell.check_call('aws-ec2-wait-for-state -e running', *[i.instance_id for i in pendings])
    instances = [i for i in cli_aws.ls(selectors, None) if i.state['Name'] in ['running', 'stopped']]
    assert instances, 'didnt find any instances for those selectors'
    logging.info('going to stop the following instances:')
    for i in instances:
        logging.info(' ' + cli_aws.format(i))
    if not yes:
        logging.info('\nwould you like to proceed? y/n\n')
        assert shell.getch() == 'y', 'abort'
    retry(boto3.client('ec2').stop_instances)(InstanceIds=[i.instance_id for i in instances])

if __name__ == '__main__':
    with cli_aws.setup():
        argh.dispatch_command(main)
