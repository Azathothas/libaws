#!/usr/bin/env python3
import sys
import tempfile
import os
import argh
import cli_aws
import shell

@argh.arg('-p', '--payload')
def main(path, payload=None, event=False):
    if payload:
        payload = f'--payload file://{payload}'
    else:
        payload = ''
    if event:
        event = '--invocation-type Event'
    else:
        event = ''
    _, temp = tempfile.mkstemp()
    print(shell.run(f'aws lambda invoke {event} {payload} --function-name {cli_aws.lambda_name(path)} {temp}'), file=sys.stderr)
    with open(temp) as f:
        print(f.read())
    os.remove(temp)

if __name__ == '__main__':
    with cli_aws.setup():
        argh.dispatch_command(main)
